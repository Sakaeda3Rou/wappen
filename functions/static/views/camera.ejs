<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="views/css/reset.css">
    <link rel="stylesheet" href="views/css/style.css">
    <script src="https://kit.fontawesome.com/7a89e754ee.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
</head>
<body class="camera-page">
    <nav id="set-hamburger"></nav>
    <main>
        <!-- <section class="camera"> -->
        <div>
          <!-- a-sceneを開始 -->
          <a-scene vr-mode-ui="enabled: false">

            <a-assets id="assets">

              <!-- imgタグを生成 -->

            </a-assets>

            <!-- <a-entity camera style="z-index: 0"> -->
            <a-entity id="marker_area" camera>

                <!-- a-markerを生成 -->
                <!-- example -->
                <!-- <a-marker preset="hiro">
                  <a-entity
                    position="0 -1 0"
                    scale="0.05 0.05 0.05"
                    gltf-model="https://arjs-cors-proxy.herokuapp.com/https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/scene.gltf"
                  ></a-entity>
                </a-marker> -->

                <!-- <a-marker type="pattern" url="#"> -->
            </a-entity>
          </a-scene>

        </div>
        <!-- </section> -->
        <div class="btns">
            <!-- クラン選択を表示するmodalを表示するボタン -->
            <div class="btns__btn btns__btn--clan js-btn">
                <i class="fas fa-users fa-lg"></i>
                <p>クランを選択</p>
            </div>
            <!-- マイオブジェクトからカメラで映したいオブジェクトを選択するmodalを表示するボタン -->
            <div class="btns__btn btns__btn--my-object js-btn">
                <i class="fas fa-image fa-lg"></i>
                <p>オブジェクトを選択</p>
            </div>
        </div>

        <!-- 上のbtnを押したら表示される -->
        <div class="modal js-modal">
            <div class="modal__bg js-bg"></div>
            <div class="modal__main">
                <h3 id="modal__title"></h3>
                <div class="modal__form">
                    <!-- modal__listにクランかオブジェクトの一覧を表示 -->
                    <ul id="modal__list"></ul>
                    <input id="decision_button" type="button" value="決定" class="main-btn" onclick="selectButtonAction()">
                </div>
            </div>
        </div>
    </main>
    <footer id="footer" style="display: none;"></footer>
    <script src="views/js/include.js"></script>
    <script src="views/js/modal.js"></script>
    <script>
      // クランリストを作成
      let clanList = []

      <% clanList.forEach((clan) => { %>
        clanList.push({
          clanId: "<%= clan.clanId %>",
          clanName: "<%= clan.clanName %>",
        });
      <% }); %>

      // オブジェクトリストを作成
      let objectList = []

      <% objectList.forEach((object) => { %>
        // urlを整形
        var url = "<%= object.objectURL %>";
        url = url.replace('amp;', '')

        objectList.push({
          objectId: "<%= object.id %>",
          objectURL: url,
        });
      <% }); %>

      // マーカーリストを作成
      let markerList = []

      <% markerList.forEach((marker) => { %>
        markerList.push({
          markerURL: "<%= marker.markerURL %>",
          objectURL: "<%= marker.objectURL %>",
        })
      <% }); %>

    </script>
    <script src="views/js/cameraBtn.js"></script>
    <script>
      // a-markerを生成
      // setARMarker();

      function setARMarker() {
        // マーカーを生成する領域を取得
        const marker_area = document.getElementById('marker-area');

        // すでにマーカーが存在していた場合、削除する
        if (marker_area.hasChildNodes) {
          // 子要素を削除
          while (marker_area.firstChild) {
            marker_area.removeChild(marker_area.firstChild);
          }
        }

        for (let marker of markerList) {
          // a-markerタグを作成
          const a_marker_element = document.createElement('a-marker');
          a_marker_element.setAttribute('type', 'pattern');
          // a_marker_element.setAttribute('url', `${marker.markerURL}`);

          // a-entityタグを作成
          const a_entity_element = document.createElement('a-entity');
          a_entity_element.setAttribute('position', '0 -1 0');
          a_entity_element.setAttribute('scale', '0.05 0.05 0.05');
          // a_entity_element.setAttribute('gltf-model', `${marker.objectURL}`);

          // divに追加
          a_marker_element.appendChild(a_entity_element);
          marker_area.appendChild(a_marker_element);

        }
      }

    </script>
    <script>
      // 開いているモーダルを判定
      let selectType = null;


      function selectButtonAction() {
        console.log(`selecttype => ${selectType}`);

        if (selectType == 0) {
          // クランを選択したよ
          selectedClan();
        } else if (selectType == 1) {
          // オブジェクトを選択したよ
          selectedObject();
        }
      }

      // TODO: クランが選択された時

      function selectedClan() {
        // 選択されたクランのIDを取得
        let clanId = null;
        const radio_element = document.getElementsByName('clanRadio');
        for (let radio of radio_element) {
          if (radio.checked) {
            clanId = radio.value;
          }
        }
        console.log(`clanId => ${clanId}`);

        // 選択されたクランのマーカーリストを取得
        let xhr = new XMLHttpRequest();

        // サーバーに送信
        xhr.open('post', '/clan_selected');
        xhr.send(JSON.stringify({clanId: clanId}));

        // サーバーの応答を検知
        xhr.onreadystatechange = function () {
            if(xhr.readyState === 4 && xhr.status === 200){
                // マーカーリストを取得
                let markerList = JSON.parse(xhr.responseText);

                console.log(`markerList => ${markerList}`);
                console.dir(markerList);

                // マーカーをセット
                setMarker(markerList);
            }
        };
      }

      // TODO: オブジェクトが選択された時
      function selectedObject() {

      }

    </script>
    <script>
      // TODO
      setMarker([]);

      function setMarker(markerList) {

        // マーカーリスト、imageタグを生成する領域を取得
        const marker_area_element = document.getElementById('marker_area');
        const assets_element = document.getElementById('assets');

        // TODO: 既存のマーカー、assetsを削除

        // マーカーリストを生成
        for (let marker of markerList) {

          // imgタグを作成
          // const image_element = document.createElement('img');
          // image_element.hidden = true;
          // image_element.setAttribute('id', `${marker.id}`);
          // image_element.setAttribute('src', `${marker.objectURL}`);
          //
          // // assets領域に追加
          // assets_element.appendChild(image_element);
          //
          // // a-markerタグを作成
          // const marker_element = document.createElement('a-marker');
          // marker_element.setAttribute('type', 'pattern');
          // marker_element.setAttribute('url', `${marker.markerURL}`);
          //
          // // a-planeタグを作成
          // const plane_element = document.createElement('a-plane');
          // plane_element.setAttribute('position', '0 0 0');
          // plane_element.setAttribute('rotation', '-90 0 0');
          // plane_element.setAttribute('material', `src: #${marker.id}`);
          //
          // // マーカーリスト領域に追加
          // marker_element.appendChild(plane_element);
          // marker_area_element.appendChild(marker_element);

        }

        // TODO: hiroをセット
        const hiro_image_element = document.createElement('img');
        hiro_image_element.hidden = true;
        hiro_image_element.setAttribute('id', 'hiro');
        hiro_image_element.setAttribute('src', 'https://storage.googleapis.com/download/storage/v1/b/wappen-3876c.appspot.com/o/object_images%2Fq5GsxMu8h2OAkmqxEY6prVzWAVj2?generation=1610430596097215&alt=media');

        assets_element.appendChild(hiro_image_element);

        const hiro_marker_element = document.createElement('a-marker');
        hiro_marker_element.setAttribute('preset', 'hiro');

        // const hiro_plane_element = document.createElement('a-plane');
        // hiro_plane_element.setAttribute('position', "0 0 0");
        // hiro_plane_element.setAttribute('rotation', '-90 0 0');
        // hiro_plane_element.setAttribute('material', "src: #hiro;")

        // hiro_marker_element.appendChild(hiro_plane_element);
        marker_area_element.appendChild(hiro_marker_element);


      }
    </script>
</body>
</html>
